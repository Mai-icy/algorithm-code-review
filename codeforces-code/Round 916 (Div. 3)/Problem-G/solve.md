题解

如果一个连续的灯管段中每种颜色的灯管数量都是 $0$ 或 $2$ ，那么我们就称这个灯管段为**封闭**。例如，灯管的 $[3, 2, 1, 2, 1, 3]$ 段是封闭的。此外，如果无法将一个封闭的灯管段分割成多个封闭的灯管段，那么这个灯管段就是**最小**的。例如， $[3, 2, 1, 2, 1, 3]$ 是最小的，但 $[3, 3, 2, 1, 2, 1]$ 不是，因为它可以分割成 $[3, 3]$ 和 $[2, 1, 2, 1]$ （它们都是封闭的）。

每个封闭线段都有以下特性：如果你从这个线段中的任何一盏灯开始，你就不能 "离开 "这个线段；也就是说，你不能用这个线段中的灯去点亮外面的任何一盏灯。为了证明这一点，让我们做一个相反的假设：我们从封闭的线段开始，设法点亮该线段外的一盏颜色 $x$ 的灯（这是我们点亮的线段外的第一盏灯）。我们不能用第一种操作，因为这意味着另一盏颜色为 $x$ 的灯也在这个区段中（所以它不是封闭的）；我们也不能用第二种操作，因为对于封闭区段中的每一种颜色，该颜色的两盏灯（以及它们能点亮的区段）都属于封闭区段。

对于每一个最小的封闭线段，我们只需用一盏灯（例如第一盏）就能将其点亮。因此，要计算最初点亮的一组灯 $S$ 的最小可能大小，我们只需将给定的颜色序列分割成最小封闭段即可。

不幸的是，计算可能的灯具组 $S$ 的数量就比较麻烦了。对于我们得到的每一个最小封闭线段，我们都可以计算出能够点亮整个线段的 "起始 "灯的数量，然后将它们相乘。然而，并不是最小封闭线段中的每一盏灯都能成为 "起始 "灯：例如，在线段 $[3, 2, 1, 2, 1, 3]$ 中，可以使用任何颜色 $3$ 的灯，但不能使用其他颜色的灯。

为了解决这个问题，让我们找出颜色序列中****的最小封闭线段。在上面的例子中，我们必须找出 $[3, 2, 1, 2, 1, 3]$ 和 $[2, 1, 2, 1]$ 这两个线段都是封闭的；由于 $1$ 和 $2$ 这两种颜色的灯管属于 "内 "封闭线段，所以它们不能用来照亮整个 "外 "封闭线段。因此，如果一盏灯属于 "内 "封闭段中的任何一段，那么它就不能用作起始灯。让我们标记所有这样的灯。

我们还可以证明，如果一盏灯没有被标记，那么它就可以用作起始灯。这是因为，如果我们从某盏灯开始，尝试用语句中给出的操作打开所有我们能打开的东西，我们将精确地得到这盏灯所属的最短封闭线段。证明这一点并不难：假设我们在打开整个最短的封闭线段之前就停止了；要么我们得到了多个灯段（我们可以打开它们之间的所有灯），要么我们得到了一个不封闭的线段（对于至少一种颜色，其中正好有一盏灯；因此我们可以点亮该颜色的另一盏灯）。

好了，让我们来回顾一下。我们的解决方案包括以下步骤：

- 找出所有最小的封闭灯段；
- 对于每个 "内 "段，标记其中的所有灯管，以表明它们不能用作起始灯管；
- 将给定的颜色序列分割成最少的线段；
- 对于分割后得到的每个线段，计算未标记灯管的数量，并将这些数值相乘。

最困难的部分是找到所有最小的封闭灯段。为了得到类似 $O(n^2)$ 的解，我们可以这样做：从线段的左边界开始迭代，添加线段中的第一个灯管，并不断添加下一个灯管，直到每种颜色的灯管数变成 $0$ 或 $2$ 。这就是简单版问题的解决方法。

对于难题来说，这种方法太慢了。我们必须更快地找到封闭线段。为此，我们可以使用哈希算法。很多散列方法都能帮上忙，但在我看来，最优雅的方法是 XOR 散列，其工作原理如下：

对于每种颜色，随机生成一个 $64$ 位整数，并用生成的数字替换该颜色的两次出现。然后，如果数据段是封闭的，那么数据段中所有数字的 XOR 等于 $0$ （每种颜色要么出现在 $0$ 中，要么出现在 $0$ 中）。(每种颜色要么出现 $0$ 次，要么出现 $2$ 次，因此每个整数要么取 $0$ 次，要么取 $2$ 次，所有取两次的整数抵消）。

这样，我们就可以按照以下方法找到 $O(n \log n)$ 中所有最小的封闭线段：从左到右遍历颜色数组，保持当前前缀的 XOR 值和一个映射，在映射中，每遇到一个 XOR 值，我们就存储具有该 XOR 值的最长前缀。然后，在处理完 $i$ \-th 元素后，我们可以通过在地图中查找当前的 XOR，快速找到以 $i$ \-th 元素结尾的段的左边界。之后别忘了更新地图。

这样，我们就得到了一个在 $O(n \log n)$ 中有效的解，这就足以解决难解的问题了。